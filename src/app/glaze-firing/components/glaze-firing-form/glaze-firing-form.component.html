
<h1 mat-dialog-title>{{ isEditMode ? 'Editar Queima de Glasura' : 'Adicionar Queima de Glasura' }}</h1>

<div mat-dialog-content [formGroup]="glazeFiringForm">
  <mat-form-field appearance="fill">
    <mat-label>Temperatura (°C)</mat-label>
    <input matInput type="text" formControlName="temperature" appDecimalMask required>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Tempo de Queima (horas)</mat-label>
    <input matInput type="text" formControlName="burnTime" appDecimalMask required>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Tempo de Resfriamento (horas)</mat-label>
    <input matInput type="text" formControlName="coolingTime" appDecimalMask required>
  </mat-form-field>

  <h2 class="section-title">Produtos e Glasuras</h2>

  <div formArrayName="productGroups">
    <mat-accordion multi>
      <mat-expansion-panel *ngFor="let group of productGroups.controls; let i = index" [formGroupName]="i">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ group.get('productName')?.value }} ({{ getAvailableForProduct(i) }} unidades disponíveis)
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div formArrayName="glazeApplications" class="glaze-applications-container">
          <div *ngFor="let app of glazeApplications(i).controls; let j = index" [formGroupName]="j" class="form-array-item-row">
            <button mat-icon-button color="warn" (click)="removeGlazeApplication(i, j)" title="Remover Glasura">
              <mat-icon>remove_circle</mat-icon>
            </button>
            <mat-form-field appearance="fill">
              <mat-label>Glasura</mat-label>
              <mat-select formControlName="glazeId" required>
                <mat-option *ngIf="glazes.length === 0" disabled>Não há glasuras.</mat-option>
                <mat-option *ngFor="let glaze of glazes" [value]="glaze.id">{{ glaze.color }}</mat-option>
              </mat-select>
              <mat-error *ngIf="app.get('glazeId')?.hasError('required')">Obrigatório.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>Quantidade</mat-label>
              <input matInput type="number" formControlName="quantity" min="1" [max]="getAvailableForProduct(i) + app.get('quantity')?.value" required>
              <mat-error *ngIf="app.get('quantity')?.hasError('required')">Obrigatório.</mat-error>
              <mat-error *ngIf="app.get('quantity')?.hasError('min')">Deve ser > 0.</mat-error>
              <mat-error *ngIf="app.get('quantity')?.hasError('max')">Excede o estoque.</mat-error>
            </mat-form-field>
          </div>
        </div>

        <button mat-stroked-button color="primary" (click)="addGlazeApplication(i)" [disabled]="getAvailableForProduct(i) <= 0">
          Adicionar Glasura
        </button>
        <mat-error *ngIf="getAvailableForProduct(i) <= 0" class="info-message">
          Não há mais unidades disponíveis para este produto.
        </mat-error>

      </mat-expansion-panel>
      <mat-option *ngIf="productTransactions.length === 0" disabled>Não há produtos (biscoitos) disponíveis para queima.</mat-option>
    </mat-accordion>
  </div>
  <mat-error *ngIf="glazeFiringForm.hasError('invalid') && glazeFiringForm.touched">
    Por favor, preencha todos os campos obrigatórios.
  </mat-error>

  <!-- Seção de Uso de Funcionários -->
  <h2 class="section-title">Uso de Funcionários</h2>
  <div formArrayName="employeeUsages">
    <div *ngFor="let employeeUsage of employeeUsages.controls; let i=index" [formGroupName]="i" class="form-array-item">
      <div class="form-array-item-row">
        <button mat-icon-button color="warn" (click)="removeEmployeeUsage(i)" title="Remover Funcionário">
          <mat-icon>remove_circle</mat-icon>
        </button>
        <mat-form-field appearance="fill">
          <mat-label>Funcionário</mat-label>
<mat-select formControlName="employeeId" required>
            <mat-option *ngIf="employees.length === 0" disabled>Não há funcionários cadastrados.</mat-option>
            <mat-option *ngFor="let employee of getAvailableEmployees(i)" [value]="employee.id">{{ employee.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Tempo de Uso (horas)</mat-label>
          <input matInput type="text" formControlName="usageTime" appDecimalMask required>
        </mat-form-field>
      </div>
    </div>
  </div>
  <ng-container *ngIf="employeeUsages.length < employees.length; else noMoreEmployees">
    <button mat-stroked-button color="primary" (click)="addEmployeeUsage()">Adicionar Funcionário</button>
  </ng-container>
  <ng-template #noMoreEmployees>
    <p class="info-message">Todos os funcionários já foram adicionados.</p>
  </ng-template>

</div>

<div mat-dialog-actions>
  <button mat-button (click)="onCancel()">Cancelar</button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="glazeFiringForm.invalid">Salvar</button>
</div>
