<h1 mat-dialog-title>{{ isEditMode ? 'Editar Queima de Biscoito' : 'Adicionar Queima de Biscoito' }}</h1>

<div mat-dialog-content [formGroup]="bisqueFiringForm">
  <mat-form-field appearance="fill">
    <mat-label>Temperatura (°C)</mat-label>
    <input matInput type="text" formControlName="temperature" appDecimalMask required>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Tempo de Queima (horas)</mat-label>
    <input matInput type="text" formControlName="burnTime" appDecimalMask required>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Tempo de Resfriamento (horas)</mat-label>
    <input matInput type="text" formControlName="coolingTime" appDecimalMask required>
  </mat-form-field>

  <h2 class="section-title">Produtos</h2>
  <div formArrayName="firedProducts">
    <mat-accordion multi>
      <mat-expansion-panel *ngFor="let productGroup of firedProducts.controls; let i = index" [formGroupName]="i">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ productGroup.get('productName')?.value }} 
            ({{ groupedProducts.get(productGroup.get('productName')?.value)?.length || 0 }} unidades disponíveis)
          </mat-panel-title>
        </mat-expansion-panel-header>

        <mat-form-field appearance="fill">
          <mat-label>Quantidade a queimar</mat-label>
          <input matInput type="number" formControlName="quantity" min="0" [max]="groupedProducts.get(productGroup.get('productName')?.value)?.length || 0">
          <mat-error *ngIf="productGroup.get('quantity')?.hasError('required')">A quantidade é obrigatória.</mat-error>
          <mat-error *ngIf="productGroup.get('quantity')?.hasError('min')">A quantidade não pode ser negativa.</mat-error>
          <mat-error *ngIf="productGroup.get('quantity')?.hasError('max')">A quantidade excede o disponível.</mat-error>
          <mat-error *ngIf="productGroup.get('quantity')?.hasError('pattern')">A quantidade deve ser um número inteiro.</mat-error>
        </mat-form-field>

      </mat-expansion-panel>
      <mat-option *ngIf="productTransactions.length === 0" disabled>Não há produtos disponíveis para queima.</mat-option>
    </mat-accordion>
  </div>
  <mat-error *ngIf="firedProducts.hasError('required') && firedProducts.touched">
    Pelo menos um produto deve ser selecionado.
  </mat-error>

  <!-- Seção de Uso de Funcionários -->
  <h2 class="section-title">Uso de Funcionários</h2>
  <div formArrayName="employeeUsages">
    <div *ngFor="let employeeUsage of employeeUsages.controls; let i=index" [formGroupName]="i" class="form-array-item">
      <div class="form-array-item-row">
        <button mat-icon-button color="warn" (click)="removeEmployeeUsage(i)" title="Remover Funcionário">
          <mat-icon>remove_circle</mat-icon>
        </button>
        <mat-form-field appearance="fill">
          <mat-label>Funcionário</mat-label>
          <mat-select formControlName="employeeId" required>
                      <mat-option *ngIf="employees.length === 0" disabled>Não há funcionários cadastrados.</mat-option>
                      <mat-option *ngFor="let employee of getAvailableEmployees(i)" [value]="employee.id">{{ employee.name }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="fill">
                    <mat-label>Tempo de Uso (horas)</mat-label>
                    <input matInput type="text" formControlName="usageTime" appDecimalMask required>
                  </mat-form-field>                </div>
              </div>
            </div>
            <ng-container *ngIf="employeeUsages.length < employees.length; else noMoreEmployees">
              <button mat-stroked-button color="primary" (click)="addEmployeeUsage()">Adicionar Funcionário</button>
            </ng-container>
            <ng-template #noMoreEmployees>
              <p class="info-message">Todos os funcionários já foram adicionados.</p>
            </ng-template>
</div>

<div mat-dialog-actions>
  <button mat-button (click)="onCancel()">Cancelar</button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="bisqueFiringForm.invalid">Salvar</button>
</div>